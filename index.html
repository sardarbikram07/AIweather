<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            overflow-x: hidden;
            position: relative;
        }

        /* Enhanced Background Effects */
        .starry-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        /* Multiple star layers for depth */
        .star-layer-1 {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .star-layer-2 {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .star-layer-3 {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 4px rgba(255, 255, 255, 0.8);
        }

        /* Layer 1 - Fast moving stars */
        .star-layer-1 .star {
            animation: moveDiagonal 6s linear infinite;
        }

        .star-layer-1 .star:nth-child(1) {
            width: 2px;
            height: 2px;
            top: -10px;
            right: 10%;
            animation-delay: 0s;
        }

        .star-layer-1 .star:nth-child(2) {
            width: 1px;
            height: 1px;
            top: -5px;
            right: 25%;
            animation-delay: 0.5s;
        }

        .star-layer-1 .star:nth-child(3) {
            width: 3px;
            height: 3px;
            top: -15px;
            right: 40%;
            animation-delay: 1s;
        }

        .star-layer-1 .star:nth-child(4) {
            width: 1px;
            height: 1px;
            top: -8px;
            right: 55%;
            animation-delay: 1.5s;
        }

        .star-layer-1 .star:nth-child(5) {
            width: 2px;
            height: 2px;
            top: -12px;
            right: 70%;
            animation-delay: 2s;
        }

        /* Layer 2 - Medium speed stars */
        .star-layer-2 .star {
            animation: moveDiagonal 8s linear infinite;
        }

        .star-layer-2 .star:nth-child(1) {
            width: 1px;
            height: 1px;
            top: -6px;
            right: 15%;
            animation-delay: 0.3s;
        }

        .star-layer-2 .star:nth-child(2) {
            width: 2px;
            height: 2px;
            top: -10px;
            right: 35%;
            animation-delay: 0.8s;
        }

        .star-layer-2 .star:nth-child(3) {
            width: 1px;
            height: 1px;
            top: -8px;
            right: 60%;
            animation-delay: 1.3s;
        }

        .star-layer-2 .star:nth-child(4) {
            width: 3px;
            height: 3px;
            top: -15px;
            right: 80%;
            animation-delay: 1.8s;
        }

        .star-layer-2 .star:nth-child(5) {
            width: 1px;
            height: 1px;
            top: -5px;
            right: 5%;
            animation-delay: 2.3s;
        }

        /* Layer 3 - Slow moving stars */
        .star-layer-3 .star {
            animation: moveDiagonal 12s linear infinite;
        }

        .star-layer-3 .star:nth-child(1) {
            width: 2px;
            height: 2px;
            top: -12px;
            right: 20%;
            animation-delay: 0.7s;
        }

        .star-layer-3 .star:nth-child(2) {
            width: 1px;
            height: 1px;
            top: -7px;
            right: 45%;
            animation-delay: 1.2s;
        }

        .star-layer-3 .star:nth-child(3) {
            width: 3px;
            height: 3px;
            top: -18px;
            right: 75%;
            animation-delay: 1.7s;
        }

        .star-layer-3 .star:nth-child(4) {
            width: 1px;
            height: 1px;
            top: -9px;
            right: 90%;
            animation-delay: 2.2s;
        }

        /* Shooting stars */
        .shooting-star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: linear-gradient(45deg, white, transparent);
            border-radius: 50%;
            animation: shootingStar 4s linear infinite;
            opacity: 0;
        }

        .shooting-star:nth-child(1) {
            top: 20%;
            left: 10%;
            animation-delay: 0s;
        }

        .shooting-star:nth-child(2) {
            top: 60%;
            left: 30%;
            animation-delay: 2s;
        }

        .shooting-star:nth-child(3) {
            top: 40%;
            left: 70%;
            animation-delay: 4s;
        }

        /* Floating particles */
        .particle {
            position: absolute;
            width: 1px;
            height: 1px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            animation: float 10s ease-in-out infinite;
        }

        .particle:nth-child(1) {
            top: 10%;
            left: 20%;
            animation-delay: 0s;
        }

        .particle:nth-child(2) {
            top: 30%;
            left: 80%;
            animation-delay: 2s;
        }

        .particle:nth-child(3) {
            top: 70%;
            left: 15%;
            animation-delay: 4s;
        }

        .particle:nth-child(4) {
            top: 80%;
            left: 85%;
            animation-delay: 6s;
        }

        .particle:nth-child(5) {
            top: 50%;
            left: 50%;
            animation-delay: 8s;
        }

        @keyframes moveDiagonal {
            0% { 
                transform: translate(0, 0) scale(0.8);
                opacity: 0;
            }
            10% {
                opacity: 1;
                transform: translate(0, 0) scale(1);
            }
            90% {
                opacity: 1;
                transform: translate(-100px, calc(100vh + 20px)) scale(1);
            }
            100% { 
                transform: translate(-100px, calc(100vh + 20px)) scale(0.8);
                opacity: 0;
            }
        }

        @keyframes shootingStar {
            0% {
                transform: translateX(0) translateY(0) rotate(45deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
                transform: translateX(200px) translateY(200px) rotate(45deg);
            }
            100% {
                transform: translateX(200px) translateY(200px) rotate(45deg);
                opacity: 0;
            }
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px) scale(1);
                opacity: 0.3;
            }
            50% {
                transform: translateY(-20px) scale(1.2);
                opacity: 0.8;
            }
        }

        /* Gradient overlay for depth */
        .background-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, transparent 0%, rgba(0,0,0,0.3) 100%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            animation: fadeIn 0.8s ease-out;
            position: relative;
            z-index: 1;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.02));
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            color: white;
            font-size: 1.8em;
            font-weight: 300;
            margin-bottom: 15px;
        }

        .search-container {
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 12px 18px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            outline: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .search-input:focus {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .search-input::placeholder {
            color: #666;
        }

        .button-container {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .location-btn {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }

        .location-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(79, 172, 254, 0.4);
        }

        .location-btn:active {
            transform: translateY(0);
        }

        .search-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .loading {
            text-align: center;
            padding: 25px;
            color: white;
            font-size: 16px;
        }

        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .weather-card {
            padding: 25px;
            color: white;
            text-align: center;
        }

        .weather-icon {
            font-size: 5em;
            margin-bottom: 15px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .temperature {
            font-size: 3.5em;
            font-weight: 300;
            margin-bottom: 8px;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .description {
            font-size: 1.2em;
            margin-bottom: 20px;
            opacity: 0.9;
            text-transform: capitalize;
        }

        .location {
            font-size: 1em;
            opacity: 0.8;
            margin-bottom: 20px;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .detail-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .detail-card:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .detail-icon {
            font-size: 1.5em;
            margin-bottom: 8px;
        }

        .detail-value {
            font-size: 1em;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .detail-label {
            font-size: 0.8em;
            opacity: 0.7;
        }

        /* Forecast Styles */
        .forecast-section {
            margin-top: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .forecast-title {
            text-align: center;
            color: white;
            font-size: 1.3em;
            margin-bottom: 20px;
            font-weight: 300;
        }

        .forecast-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .forecast-day {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            color: white;
            transition: all 0.3s ease;
        }

        .forecast-day:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-3px);
        }

        .forecast-date {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 8px;
        }

        .forecast-day-name {
            font-size: 1em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .forecast-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .forecast-temp {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .forecast-description {
            font-size: 0.8em;
            opacity: 0.8;
            text-transform: capitalize;
        }

        .forecast-details {
            margin-top: 8px;
            font-size: 0.7em;
            opacity: 0.7;
        }

        .error {
            text-align: center;
            padding: 25px;
            color: #ff6b6b;
            font-size: 16px;
        }

        .error-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }

        .retry-btn {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .retry-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 107, 107, 0.3);
        }

        /* Chatbot Styles */
        .chat-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-button:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.6);
        }

        .chat-button.close {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
        }

        .chat-button.close:hover {
            box-shadow: 0 12px 35px rgba(255, 107, 107, 0.6);
        }

        .chat-window {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 350px;
            height: 500px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            display: none;
            flex-direction: column;
            z-index: 999;
            animation: slideIn 0.3s ease-out;
        }

        .chat-window.active {
            display: flex;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .chat-status {
            width: 8px;
            height: 8px;
            background: #4CAF50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 6px;
        }

        .message.bot {
            background: #f1f3f4;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 6px;
        }

        .chat-input-container {
            padding: 15px 20px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .send-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .send-button:hover {
            transform: scale(1.1);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .typing-indicator {
            display: none;
            align-self: flex-start;
            padding: 12px 16px;
            background: #f1f3f4;
            border-radius: 18px;
            border-bottom-left-radius: 6px;
            font-size: 14px;
            color: #666;
        }

        .typing-indicator.active {
            display: block;
        }

        .typing-dots {
            display: inline-block;
        }

        .typing-dots span {
            display: inline-block;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: #666;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-6px);
                opacity: 1;
            }
        }

        @media (max-width: 600px) {
            .container {
                margin: 10px;
                border-radius: 15px;
                max-width: 95%;
            }
            
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.6em;
            }
            
            .weather-card {
                padding: 20px;
            }
            
            .weather-icon {
                font-size: 4em;
            }
            
            .temperature {
                font-size: 2.8em;
            }
            
            .button-container {
                flex-direction: column;
                gap: 8px;
            }
            
            .search-btn, .location-btn {
                width: 100%;
                padding: 12px 18px;
            }
            
            .details-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .forecast-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 10px;
            }

            .chat-window {
                width: calc(100vw - 40px);
                height: 60vh;
                right: 20px;
                left: 20px;
                bottom: 80px;
            }

            .chat-button {
                bottom: 20px;
                right: 20px;
            }
        }

        @media (max-width: 400px) {
            .details-grid {
                grid-template-columns: 1fr;
            }
            
            .forecast-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="starry-background">
        <!-- Layer 1 - Fast moving stars -->
        <div class="star-layer-1">
            <div class="star"></div>
            <div class="star"></div>
            <div class="star"></div>
            <div class="star"></div>
            <div class="star"></div>
        </div>
        
        <!-- Layer 2 - Medium speed stars -->
        <div class="star-layer-2">
            <div class="star"></div>
            <div class="star"></div>
            <div class="star"></div>
            <div class="star"></div>
            <div class="star"></div>
        </div>
        
        <!-- Layer 3 - Slow moving stars -->
        <div class="star-layer-3">
            <div class="star"></div>
            <div class="star"></div>
            <div class="star"></div>
            <div class="star"></div>
        </div>
        
        <!-- Shooting stars -->
        <div class="shooting-star"></div>
        <div class="shooting-star"></div>
        <div class="shooting-star"></div>
        
        <!-- Floating particles -->
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>
    
    <!-- Background overlay for depth -->
    <div class="background-overlay"></div>
    
    <div class="container">
        <div class="header">
            <h1>🌤️ Weather App</h1>
            <div class="search-container">
                <input type="text" id="cityInput" class="search-input" placeholder="Enter city name (e.g., London, New York, Tokyo)" onkeypress="handleEnterKey(event)">
            </div>
            <div class="button-container">
                <button class="search-btn" onclick="searchWeather()">🔍 Search Weather</button>
                <button class="location-btn" onclick="getCurrentLocationWeather()">📍 Current Location</button>
            </div>
        </div>
        
        <div id="content">
            <div class="weather-card">
                <div style="font-size: 3em; margin-bottom: 15px;">🌍</div>
                <div style="font-size: 1em; opacity: 0.8;">Enter a city name or use your current location</div>
            </div>
        </div>
    </div>

    <!-- Chatbot -->
    <button class="chat-button" id="chatButton" onclick="toggleChat()">
        💬
    </button>

    <div class="chat-window" id="chatWindow">
        <div class="chat-header">
            <div class="chat-status"></div>
            <h3>Weather Assistant</h3>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="message bot">
                👋 Hello! I'm your weather assistant. How can I help you today?
            </div>
        </div>
        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
            Assistant is typing...
        </div>
        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chatInput" placeholder="Type your message..." onkeypress="handleChatEnter(event)">
            <button class="send-button" onclick="sendMessage()" id="sendButton">
                ➤
            </button>
        </div>
    </div>

    <script>
        const API_KEY = '5a22760f6865bf1b8b4c73bd36c37643';
        const API_URL = 'https://api.openweathermap.org/data/2.5/weather';
        const FORECAST_API_URL = 'https://api.openweathermap.org/data/2.5/forecast';

        // Chatbot functionality
        let isChatOpen = false;
        let isTyping = false;
        let currentWeatherData = null;
        let currentForecastData = null;

        function toggleChat() {
            const chatWindow = document.getElementById('chatWindow');
            const chatButton = document.getElementById('chatButton');
            
            isChatOpen = !isChatOpen;
            
            if (isChatOpen) {
                chatWindow.classList.add('active');
                chatButton.classList.add('close');
                chatButton.innerHTML = '✕';
                document.getElementById('chatInput').focus();
            } else {
                chatWindow.classList.remove('active');
                chatButton.classList.remove('close');
                chatButton.innerHTML = '💬';
            }
        }

        function handleChatEnter(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message || isTyping) return;
            
            // Add user message
            addMessage(message, 'user');
            input.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                // Call Gemini API with weather context
                const aiResponse = await callGeminiAPI(message);
                hideTypingIndicator();
                addMessage(aiResponse, 'bot');
            } catch (error) {
                hideTypingIndicator();
                addMessage("I'm sorry, I'm having trouble connecting right now. Please try again later.", 'bot');
                console.error('Gemini API Error:', error);
            }
        }

        async function callGeminiAPI(userMessage) {
            const GEMINI_API_KEY = 'AIzaSyBdTUTNQ_K74nj-Sp08vDw6bXlBOifPLg4';
            const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';
            
            // Prepare weather context
            let weatherContext = "No weather data available.";
            if (currentWeatherData) {
                const temp = Math.round(currentWeatherData.main.temp);
                const description = currentWeatherData.weather[0].description;
                const humidity = currentWeatherData.main.humidity;
                const windSpeed = Math.round(currentWeatherData.wind.speed * 3.6);
                const city = currentWeatherData.name;
                const country = currentWeatherData.sys.country;
                
                weatherContext = `Current weather in ${city}, ${country}: Temperature is ${temp}°C, ${description}, Humidity: ${humidity}%, Wind Speed: ${windSpeed} km/h`;
            }
            
            const prompt = `Based on the current temperature and weather conditions: ${weatherContext}

User query: ${userMessage}

Please provide a helpful, friendly response as a weather assistant. Keep your response conversational and informative. If the user asks about weather, provide relevant advice based on the current conditions. If they ask about other topics, be helpful but remind them you're primarily a weather assistant.`;

            const requestBody = {
                contents: [
                    {
                        parts: [
                            {
                                text: prompt
                            }
                        ]
                    }
                ]
            };

            const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                throw new Error(`API request failed: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0]) {
                return data.candidates[0].content.parts[0].text;
            } else {
                throw new Error('Invalid response format from Gemini API');
            }
        }

        function addMessage(text, sender) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            if (sender === 'bot') {
                // Convert Markdown to HTML for bold and italics
                let html = text
                    .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>') // bold
                    .replace(/\*(.*?)\*/g, '<i>$1</i>')      // italics with *
                    .replace(/_(.*?)_/g, '<i>$1</i>')         // italics with _
                    .replace(/\n/g, '<br>');                // line breaks
                messageDiv.innerHTML = html;
            } else {
                messageDiv.textContent = text;
            }
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTypingIndicator() {
            isTyping = true;
            document.getElementById('typingIndicator').classList.add('active');
            document.getElementById('sendButton').disabled = true;
        }

        function hideTypingIndicator() {
            isTyping = false;
            document.getElementById('typingIndicator').classList.remove('active');
            document.getElementById('sendButton').disabled = false;
        }

        function getWeatherIcon(code, isDay = true) {
            const iconMap = {
                '01d': '☀️', '01n': '🌙',
                '02d': '⛅', '02n': '☁️',
                '03d': '☁️', '03n': '☁️',
                '04d': '☁️', '04n': '☁️',
                '09d': '🌧️', '09n': '🌧️',
                '10d': '🌦️', '10n': '🌧️',
                '11d': '⛈️', '11n': '⛈️',
                '13d': '❄️', '13n': '❄️',
                '50d': '🌫️', '50n': '🌫️'
            };
            return iconMap[code] || '🌤️';
        }

        function showLoading() {
            document.getElementById('content').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <div>Getting your location...</div>
                </div>
            `;
        }

        function showError(message) {
            document.getElementById('content').innerHTML = `
                <div class="error">
                    <div class="error-icon">⚠️</div>
                    <div>${message}</div>
                    <button class="retry-btn" onclick="searchWeather()">Try Again</button>
                </div>
            `;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            if (date.toDateString() === today.toDateString()) {
                return 'Today';
            } else if (date.toDateString() === tomorrow.toDateString()) {
                return 'Tomorrow';
            } else {
                return dayNames[date.getDay()];
            }
        }

        function formatDateShort(dateString) {
            const date = new Date(dateString);
            const options = { month: 'short', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        function processForecastData(forecastData) {
            const dailyData = {};
            
            forecastData.list.forEach(item => {
                const date = new Date(item.dt * 1000);
                const dayKey = date.toDateString();
                
                if (!dailyData[dayKey]) {
                    dailyData[dayKey] = {
                        date: date,
                        temps: [],
                        descriptions: [],
                        icons: [],
                        humidity: [],
                        windSpeed: []
                    };
                }
                
                dailyData[dayKey].temps.push(item.main.temp);
                dailyData[dayKey].descriptions.push(item.weather[0].description);
                dailyData[dayKey].icons.push(item.weather[0].icon);
                dailyData[dayKey].humidity.push(item.main.humidity);
                dailyData[dayKey].windSpeed.push(item.wind.speed);
            });
            
            // Get the most common weather for each day and average temperatures
            const processedData = Object.values(dailyData).map(day => {
                const avgTemp = Math.round(day.temps.reduce((a, b) => a + b, 0) / day.temps.length);
                const avgHumidity = Math.round(day.humidity.reduce((a, b) => a + b, 0) / day.humidity.length);
                const avgWindSpeed = Math.round((day.windSpeed.reduce((a, b) => a + b, 0) / day.windSpeed.length) * 3.6);
                
                // Get most common weather description and icon
                const descriptionCount = {};
                const iconCount = {};
                day.descriptions.forEach(desc => descriptionCount[desc] = (descriptionCount[desc] || 0) + 1);
                day.icons.forEach(icon => iconCount[icon] = (iconCount[icon] || 0) + 1);
                
                const mostCommonDesc = Object.keys(descriptionCount).reduce((a, b) => 
                    descriptionCount[a] > descriptionCount[b] ? a : b);
                const mostCommonIcon = Object.keys(iconCount).reduce((a, b) => 
                    iconCount[a] > iconCount[b] ? a : b);
                
                return {
                    date: day.date,
                    temp: avgTemp,
                    description: mostCommonDesc,
                    icon: mostCommonIcon,
                    humidity: avgHumidity,
                    windSpeed: avgWindSpeed
                };
            });
            
            return processedData.slice(0, 7); // Return 7 days
        }

        function displayWeather(data, forecastData = null) {
            // Store weather data for chatbot
            currentWeatherData = data;
            currentForecastData = forecastData;
            
            const temp = Math.round(data.main.temp);
            const feelsLike = Math.round(data.main.feels_like);
            const humidity = data.main.humidity;
            const windSpeed = Math.round(data.wind.speed * 3.6); // Convert m/s to km/h
            const pressure = data.main.pressure;
            const visibility = data.visibility ? Math.round(data.visibility / 1000) : 'N/A';
            const icon = getWeatherIcon(data.weather[0].icon);
            
            let weatherHTML = `
                <div class="weather-card">
                    <div class="weather-icon">${icon}</div>
                    <div class="temperature">${temp}°C</div>
                    <div class="description">${data.weather[0].description}</div>
                    <div class="location">📍 ${data.name}, ${data.sys.country}</div>
                    
                    <div class="details-grid">
                        <div class="detail-card">
                            <div class="detail-icon">🌡️</div>
                            <div class="detail-value">${feelsLike}°C</div>
                            <div class="detail-label">Feels Like</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-icon">💧</div>
                            <div class="detail-value">${humidity}%</div>
                            <div class="detail-label">Humidity</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-icon">💨</div>
                            <div class="detail-value">${windSpeed} km/h</div>
                            <div class="detail-label">Wind Speed</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-icon">🌊</div>
                            <div class="detail-value">${pressure} hPa</div>
                            <div class="detail-label">Pressure</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add forecast section if forecast data is available
            if (forecastData && forecastData.length > 0) {
                const forecastHTML = `
                    <div class="forecast-section">
                        <div class="forecast-title">📅 7-Day Forecast</div>
                        <div class="forecast-grid">
                            ${forecastData.map(day => `
                                <div class="forecast-day">
                                    <div class="forecast-date">${formatDateShort(day.date)}</div>
                                    <div class="forecast-day-name">${formatDate(day.date)}</div>
                                    <div class="forecast-icon">${getWeatherIcon(day.icon)}</div>
                                    <div class="forecast-temp">${day.temp}°C</div>
                                    <div class="forecast-description">${day.description}</div>
                                    <div class="forecast-details">
                                        💧 ${day.humidity}% | 💨 ${day.windSpeed} km/h
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                weatherHTML += forecastHTML;
            }
            
            document.getElementById('content').innerHTML = weatherHTML;
        }

        async function fetchWeatherByCity(cityName) {
            try {
                // Fetch current weather
                const weatherResponse = await fetch(
                    `${API_URL}?q=${encodeURIComponent(cityName)}&appid=${API_KEY}&units=metric`
                );
                
                if (!weatherResponse.ok) {
                    if (weatherResponse.status === 404) {
                        throw new Error('City not found. Please check the spelling and try again.');
                    }
                    throw new Error('Weather data not available');
                }
                
                const weatherData = await weatherResponse.json();
                
                // Fetch forecast data
                const forecastResponse = await fetch(
                    `${FORECAST_API_URL}?q=${encodeURIComponent(cityName)}&appid=${API_KEY}&units=metric`
                );
                
                let forecastData = null;
                if (forecastResponse.ok) {
                    const forecastRawData = await forecastResponse.json();
                    forecastData = processForecastData(forecastRawData);
                }
                
                displayWeather(weatherData, forecastData);
            } catch (error) {
                showError(error.message || 'Failed to fetch weather data. Please try again.');
            }
        }

        async function fetchWeather(lat, lon) {
            try {
                // Fetch current weather
                const weatherResponse = await fetch(
                    `${API_URL}?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric`
                );
                
                if (!weatherResponse.ok) {
                    throw new Error('Weather data not available');
                }
                
                const weatherData = await weatherResponse.json();
                
                // Fetch forecast data
                const forecastResponse = await fetch(
                    `${FORECAST_API_URL}?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric`
                );
                
                let forecastData = null;
                if (forecastResponse.ok) {
                    const forecastRawData = await forecastResponse.json();
                    forecastData = processForecastData(forecastRawData);
                }
                
                displayWeather(weatherData, forecastData);
            } catch (error) {
                console.error('Weather fetch error:', error);
                showError('Failed to fetch weather data. Please try again.');
            }
        }

        // Fallback method using IP-based location
        async function getLocationByIP() {
            try {
                const response = await fetch('https://ipapi.co/json/');
                if (response.ok) {
                    const data = await response.json();
                    console.log('IP-based location:', data);
                    return { lat: data.latitude, lon: data.longitude };
                }
            } catch (error) {
                console.error('IP location error:', error);
            }
            return null;
        }

        function searchWeather() {
            const cityInput = document.getElementById('cityInput');
            const cityName = cityInput.value.trim();
            
            if (!cityName) {
                showError('Please enter a city name');
                return;
            }
            
            document.getElementById('content').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <div>Searching for ${cityName}...</div>
                </div>
            `;
            
            fetchWeatherByCity(cityName);
        }

        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                searchWeather();
            }
        }

        async function getCurrentLocationWeather() {
            showLoading();
            
            if (!navigator.geolocation) {
                showError('Geolocation is not supported by this browser');
                return;
            }
            
            // Show more specific loading message
            document.getElementById('content').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <div>Getting your location...</div>
                    <div style="font-size: 0.8em; opacity: 0.7; margin-top: 10px;">
                        Please allow location access if prompted
                    </div>
                </div>
            `;
            
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const { latitude, longitude } = position.coords;
                    console.log('Location obtained:', { latitude, longitude, accuracy: position.coords.accuracy });
                    
                    // Show coordinates briefly for debugging
                    document.getElementById('content').innerHTML = `
                        <div class="loading">
                            <div class="spinner"></div>
                            <div>Fetching weather for your location...</div>
                            <div style="font-size: 0.8em; opacity: 0.7; margin-top: 10px;">
                                Coordinates: ${latitude.toFixed(4)}, ${longitude.toFixed(4)}
                            </div>
                        </div>
                    `;
                    
                    fetchWeather(latitude, longitude);
                },
                async (error) => {
                    console.error('Geolocation error:', error);
                    
                    // Try IP-based location as fallback
                    document.getElementById('content').innerHTML = `
                        <div class="loading">
                            <div class="spinner"></div>
                            <div>Trying alternative location method...</div>
                        </div>
                    `;
                    
                    const ipLocation = await getLocationByIP();
                    if (ipLocation) {
                        console.log('Using IP-based location:', ipLocation);
                        fetchWeather(ipLocation.lat, ipLocation.lon);
                    } else {
                        let message = 'Unable to get your location. ';
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                message += 'Please allow location access in your browser settings and try again.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                message += 'Location information unavailable. Please try again or search for a city manually.';
                                break;
                            case error.TIMEOUT:
                                message += 'Location request timed out. Please try again or search for a city manually.';
                                break;
                            default:
                                message += 'An unknown error occurred. Please try searching for a city manually.';
                        }
                        showError(message);
                    }
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000, // Increased timeout
                    maximumAge: 300000
                }
            );
        }

        // Keep the old getWeather function for backward compatibility
        function getWeather() {
            getCurrentLocationWeather();
        }

        // Auto-load weather on page load
        window.addEventListener('load', () => {
            // Add a small delay for better UX
            setTimeout(() => {
                // Don't auto-load, let user click the button
            }, 500);
        });
    </script>
</body>
</html>
